# WPF Paint Application

Приложение для рисования на WPF с поддержкой управления через джойстик, записи сессий и их воспроизведения.

## Описание

Это WPF-приложение позволяет рисовать простые фигуры (человечек, цветок) с помощью джойстика, подключенного через последовательный порт. Приложение поддерживает запись действий пользователя в базу данных MySQL и их последующее воспроизведение (демо-режим).

## Структура проекта

### Конфигурационные файлы

#### `WpfClient.csproj`
Файл проекта .NET. Содержит настройки сборки:
- Целевой фреймворк: `.NET 9.0`
- Язык: C# 13.0
- Тип проекта: WPF приложение (WinExe)
- Зависимости:
  - `System.IO.Ports` (v8.0.0) - для работы с последовательным портом
  - `MySqlConnector` (v2.4.0) - для подключения к MySQL

#### `docker-compose.yml`
Конфигурация Docker Compose для запуска MySQL базы данных:
- Образ: MySQL 8.0.36
- Порт: 3308 (внешний) → 3306 (внутренний)
- База данных: `paintdb`
- Пользователь: `paintuser` / `paintpassword`
- Автоматическая инициализация через `init.sql`

#### `init.sql`
SQL скрипт для инициализации базы данных:
- Создает базу данных `paintdb`
- Создает таблицу `sessions` для хранения сессий записи
- Создает таблицу `actions` для хранения действий пользователя
- Настраивает индексы и внешние ключи

#### `Makefile`
Утилита для автоматизации команд:
- `make build` - сборка проекта
- `make run` - запуск приложения
- `make clean` - очистка артефактов сборки
- `make docker-up` - запуск MySQL через Docker
- `make docker-down` - остановка MySQL контейнера
- `make docker-logs` - просмотр логов MySQL

#### `AppConfig.cs`
Централизованный класс конфигурации приложения:
- Размеры экрана и холста (`ScreenWidth`, `ScreenHeight`, `CanvasWidth`, `CanvasHeight`)
- Параметры последовательного порта (`BaudRate = 115200`)
- Параметры джойстика:
  - Диапазоны значений (`JoyXMin`, `JoyXMax`, `JoyYMin`, `JoyYMax`)
  - Центральные значения (`JoyXCenter`, `JoyYCenter = 2048`)
  - Мертвая зона (`JoyDeadZone = 100`)
  - Скорость движения курсора (`JoySpeedDivider = 100.0`, `JoyMaxSpeed = 10.0`)
- Позиционирование элементов интерфейса

#### `config/DatabaseConfig.cs`
Конфигурация подключения к базе данных:
- Хост и порт (`localhost:3308`)
- Имя базы данных (`paintdb`)
- Учетные данные пользователя
- Строка подключения для MySqlConnector

### Основные классы приложения

#### `App.xaml` и `App.xaml.cs`
Точка входа в приложение:
- **App.xaml.cs**: Инициализирует приложение, создает экземпляры `PaintViewModel`, `PaintEngine` и `PaintController`, связывает их друг с другом, создает и показывает главное окно. Управляет жизненным циклом контроллера (освобождение ресурсов при закрытии).

#### `MainWindow.xaml` и `MainWindow.xaml.cs`
Главное окно приложения:
- **MainWindow.xaml**: Определяет UI главного окна:
  - Canvas для отображения рисунка
  - Изображение-эталон (reference image)
  - Палитра цветов
  - Информация о текущей картинке
  - Список заполненных фигур
  - Кнопки управления (Запись, Демо, Пауза, Стоп)
  - Прогресс-бар воспроизведения
  - Кнопка переключения режима джойстика
  - Статус-сообщения
  - Кursor (внешний и внутренний круги)
- **MainWindow.xaml.cs**: Обработчики событий UI:
  - `OnRecordClick` - запуск/остановка записи
  - `OnPlaybackClick` - открытие диалога выбора сессии для воспроизведения
  - `OnPauseResumeClick` - пауза/возобновление воспроизведения
  - `OnStopPlaybackClick` - остановка воспроизведения
  - `OnJoystickModeToggle` - переключение режима джойстика

#### `PaintViewModel.cs`
ViewModel в паттерне MVVM. Связывает UI с бизнес-логикой:
- Реализует `INotifyPropertyChanged` для уведомления UI об изменениях
- Хранит состояние приложения:
  - Изображения холста и эталона
  - Выбранный цвет и его индекс
  - Текущая картинка
  - Позиция курсора
  - Статус записи/воспроизведения
  - Прогресс воспроизведения
  - Режим джойстика
  - Состояние подключения к последовательному порту
- Предоставляет коллекции для привязки данных (палитра цветов, список заполненных фигур)

#### `PaintController.cs`
Главный контроллер приложения, координирует работу всех компонентов:
- Управляет подключением к последовательному порту
- Обрабатывает сообщения от джойстика (парсинг строк формата `X:1234,Y:2345,B:0`)
- Управляет позицией курсора с учетом режима джойстика
- Обрабатывает нажатия кнопок джойстика (A-F) для выполнения действий
- Координирует запись действий через `ActionRecorder`
- Управляет воспроизведением через `Demo`
- Восстанавливает состояние пользователя после завершения демо-режима
- Переключает режимы джойстика через `JoystickModeHandler`

#### `PaintEngine.cs`
Движок рисования. Управляет логикой рисования:
- Хранит коллекцию доступных рисунков (`HumanDrawing`, `FlowerDrawing`)
- Управляет текущим активным рисунком
- Создает изображения для отображения:
  - `CreateReferenceImage()` - эталонное изображение (заполненное цветами)
  - `CreateCanvasImage()` - изображение холста (только контуры, с заполнением выбранных фигур)
- Выполняет hit-test для определения, какая фигура была нажата
- Управляет состоянием заполнения фигур (словарь `фигура → цвет`)
- Поддерживает переключение между рисунками

### Модели данных

#### `Models/ActionRecord.cs`
Модель данных для записи действия пользователя:
- **ActionType**: Перечисление типов действий:
  - `CursorMove` - движение курсора
  - `ColorSelect` - выбор цвета
  - `Fill` - заливка фигуры
  - `ClearFigure` - очистка фигуры
  - `NextPicture` - переход к следующей картинке
  - `ClearAll` - очистка всех фигур
- **ActionRecord**: Класс, содержащий все данные о действии:
  - `Id`, `SessionId` - идентификаторы
  - `ActionType`, `TimestampMs`, `OccurredAt` - тип и временные метки
  - `CursorX/Y`, `CanvasX/Y` - координаты курсора и нажатия на холст
  - `ColorIndex`, `ColorHex` - информация о цвете
  - `FigureName` - название фигуры (для Fill/ClearFigure)
  - `ButtonPressed` - нажатая кнопка (A-F)
  - `RawX/Y` - сырые значения с джойстика
  - `AdditionalData` - дополнительные данные в JSON

#### `Services/SessionInfo.cs` (используется в `Demo.cs`)
Модель информации о сессии:
- `Id` - идентификатор сессии
- `StartedAt`, `EndedAt` - время начала и окончания
- `DrawingKey` - ключ используемого рисунка
- `ActionCount` - количество действий в сессии

### Сервисы

#### `Services/ActionRecorder.cs`
Сервис для записи действий пользователя в базу данных:
- **StartSessionAsync()**: Начинает новую сессию записи, создает запись в таблице `sessions`
- **StopSessionAsync()**: Завершает текущую сессию, обновляет время окончания
- **RecordActionAsync()**: Записывает одно действие в таблицу `actions` с временной меткой относительно начала сессии
- Использует `SemaphoreSlim` для синхронизации асинхронных операций
- Обрабатывает ошибки подключения к БД

#### `Services/Demo.cs` (ранее `ActionPlayback.cs`)
Сервис для воспроизведения записанных сессий:
- **GetAvailableSessionsAsync()**: Получает список всех доступных сессий из БД с подсчетом действий
- **PlaybackSessionAsync()**: Воспроизводит сессию:
  - Загружает действия из БД по порядку временных меток
  - Воспроизводит действия с правильными задержками
  - Поддерживает паузу/возобновление
  - Отслеживает прогресс и вызывает события `ProgressChanged`
  - Вызывает событие `ActionReplayed` для каждого действия
- **DeleteSessionAsync()**: Удаляет сессию из БД (каскадное удаление действий через FK)
- **PausePlayback()**, **ResumePlayback()**, **StopPlayback()**: Управление воспроизведением
- Использует `Dispatcher` для безопасного обновления UI из фонового потока

### Обработка джойстика

#### `JoystickModeHandler.cs`
Обработчик нормализации данных джойстика для разных режимов:
- **JoystickMode**: Перечисление режимов:
  - `Absolute` - абсолютное позиционирование (курсор движется от текущей позиции)
  - `Centered` - центрированный режим (курсор возвращается в центр при отпускании джойстика)
- **NormalizeX/Y()**: Публичные методы для нормализации координат в зависимости от режима
- **NormalizeAbsoluteX/Y()**: Логика абсолютного режима:
  - Если джойстик в мертвой зоне - курсор не двигается
  - Скорость движения зависит от отклонения джойстика от центра
  - Ограничивается максимальной скоростью и границами экрана
- **NormalizeCenteredX/Y()**: Логика центрированного режима:
  - Если джойстик в мертвой зоне - возвращает центр экрана
  - Позиция курсора вычисляется относительно центра экрана пропорционально отклонению джойстика
  - Применяется коэффициент замедления для плавности
- **IsInDeadZone()**: Проверка, находится ли джойстик в мертвой зоне
- **GetCenter()**: Возвращает координаты центра экрана

### Рисунки (Drawings)

#### `Drawings/DrawingDefinition.cs`
Абстрактный базовый класс для определения рисунка:
- **Свойства**:
  - `Key` - уникальный ключ рисунка (используется в БД)
  - `DisplayName` - отображаемое имя
  - `BaseSize` - базовый размер (200x200)
- **Методы**:
  - `DrawReference()` - рисование эталонного изображения (заполненного цветами)
  - `DrawCanvas()` - рисование на холсте (контуры + заполненные фигуры)
  - `DrawReferenceOutlines()` - рисование контуров на эталоне
  - `HitTest()` - определение, какая фигура была нажата
  - `DrawFilledFigures()` - рисование заполненных фигур (абстрактный)
  - `DrawOutlines()` - рисование контуров (абстрактный)
  - `HitTestCore()` - логика hit-test (абстрактный)

#### `Drawings/HumanDrawing.cs`
Реализация рисунка "Человечек":
- Фигуры: голова (круг), тело (прямоугольник), 2 руки, 2 ноги
- Эталон: голова - желтая, тело - синее, руки - красные, ноги - зеленые
- Холст: только контуры, заполняются по выбору пользователя

#### `Drawings/FlowerDrawing.cs`
Реализация рисунка "Цветок":
- Фигуры: 4 лепестка (круги), стебель (прямоугольник), 2 листа (круги)
- Эталон: лепестки разных цветов (розовый, желтый, пурпурный, бирюзовый), стебель и листья - зеленые
- Холст: только контуры, заполняются по выбору пользователя

### UI компоненты

#### `PlaybackDialog.xaml` и `PlaybackDialog.xaml.cs`
Диалог выбора сессии для воспроизведения:
- **PlaybackDialog.xaml**: UI диалога:
  - `ListBox` со списком сессий (дата, рисунок, количество действий)
  - Визуальное выделение выбранной сессии (синий фон, маркер ▶)
  - Кнопка удаления сессии (появляется при наведении на элемент списка)
  - Кнопки "Воспроизвести" и "Отмена"
- **PlaybackDialog.xaml.cs**: Логика диалога:
  - Инициализация списка сессий
  - Обработка выбора сессии
  - Удаление сессии с подтверждением
  - Возврат `SelectedSessionId` при подтверждении

#### `ColorOption.cs`
Модель цвета для палитры:
- **ColorOption**: Класс, представляющий один цвет:
  - `Index` - индекс в палитре
  - `Name` - название цвета (на русском)
  - `Color` - цвет WPF
  - `Brush` - кисть для рисования (замороженная для производительности)
- **ColorPalette**: Статический класс с предопределенной палитрой:
  - 12 цветов: черный, красный, зеленый, синий, желтый, бирюзовый, пурпурный, оранжевый, фиолетовый, коричневый, розовый, белый

### Дополнительные файлы

#### `AssemblyInfo.cs`
Атрибуты сборки для WPF:
- `ThemeInfo` - указывает расположение словарей ресурсов тем

#### `.gitignore`
Игнорируемые файлы Git:
- `bin/`, `obj/` - артефакты сборки
- `.vs/`, `.idea/` - настройки IDE
- `*.user`, `*.suo` - пользовательские настройки проекта
- `*~`, `*.tmp`, `*.log` - временные файлы
- NuGet и системные файлы

## Установка и запуск

### Требования
- .NET 9.0 SDK
- Docker Desktop (для MySQL)
- Джойстик, подключенный через последовательный порт (опционально)

### Запуск базы данных

```bash
# Запуск MySQL через Docker
docker-compose up -d

# Или через Makefile
make docker-up
```

### Сборка и запуск приложения

```bash
# Сборка
dotnet build

# Запуск
dotnet run

# Или через Makefile
make build
make run
```

## Использование

1. **Подключение джойстика**: Приложение автоматически ищет последовательный порт и подключается к нему (скорость 115200 бод)

2. **Управление курсором**:
   - Джойстик перемещает курсор по экрану
   - Кнопка переключения режима джойстика позволяет выбрать между абсолютным и центрированным режимом

3. **Рисование**:
   - Нажмите кнопку джойстика, когда курсор находится над фигурой, чтобы залить её выбранным цветом
   - Кнопки для выбора цвета (A-F) и других действий (смена картинки, очистка)

4. **Запись сессии**:
   - Нажмите кнопку "Запись" для начала записи действий
   - Все действия сохраняются в базу данных
   - Нажмите еще раз для остановки записи

5. **Воспроизведение (демо-режим)**:
   - Нажмите "Демо режим"
   - Выберите сессию из списка
   - Нажмите "Воспроизвести"
   - Используйте кнопки "Пауза" и "Стоп" для управления воспроизведением

## Архитектура

Приложение использует паттерн MVVM (Model-View-ViewModel):
- **Model**: `ActionRecord`, `ColorOption`, рисунки
- **View**: `MainWindow.xaml`, `PlaybackDialog.xaml`
- **ViewModel**: `PaintViewModel`
- **Controller**: `PaintController` (координирует взаимодействие компонентов)

Дополнительно:
- **Engine**: `PaintEngine` (бизнес-логика рисования)
- **Services**: `ActionRecorder`, `Demo` (работа с БД)
- **Handler**: `JoystickModeHandler` (обработка джойстика)

## Технологии

- **WPF** - UI фреймворк
- **.NET 9.0** - платформа
- **C# 13.0** - язык программирования
- **MySQL 8.0** - база данных
- **Docker** - контейнеризация БД
- **MySqlConnector** - драйвер БД
- **System.IO.Ports** - работа с последовательным портом

