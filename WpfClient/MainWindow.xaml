<Window x:Class="WpfClient.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WpfClient"
        xmlns:controls="clr-namespace:WpfClient.Controls"
        mc:Ignorable="d"
        Title="Paint"
        Width="1260"
        Height="840"
        MinWidth="1180"
        MinHeight="820"
        Background="{DynamicResource WindowBackgroundBrush}"
        WindowStartupLocation="CenterScreen">

    <!-- Корневой Grid вместо Viewbox -->
    <Grid Margin="24">
        <!-- Белая карточка по центру -->
        <Border CornerRadius="28"
                Background="White"
                Effect="{StaticResource MediumShadow}">
            <Grid Margin="32">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Заголовок -->
                    <RowDefinition Height="*"/>
                    <!-- Основная часть -->
                    <RowDefinition Height="Auto"/>
                    <!-- Нижняя панель -->
                </Grid.RowDefinitions>

                <!-- ====================== ЗАГОЛОВОК ====================== -->
                <StackPanel Grid.Row="0">
                    <TextBlock Text="Paint Receiver"
                               FontSize="32"
                               FontWeight="SemiBold" />
                    <TextBlock Text="Раскрашивание с управлением джойстиком"
                               FontSize="16"
                               Foreground="{StaticResource MutedTextBrush}"
                               Margin="0,8,0,0" />
                </StackPanel>

                <!-- ====================== ОСНОВНАЯ ОБЛАСТЬ ====================== -->
                <Grid Grid.Row="1" Margin="0,24,0,24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="260"/>
                        <!-- Левая колонка -->
                        <ColumnDefinition Width="*"/>
                        <!-- Холст -->
                        <ColumnDefinition Width="260"/>
                        <!-- Правая колонка -->
                    </Grid.ColumnDefinitions>

                    <!-- ЛЕВАЯ КОЛОНКА: инфо + хоткеи -->
                    <StackPanel Grid.Column="0" VerticalAlignment="Stretch">
                        <controls:InfoPanel />

                        <controls:HotkeysPanel Margin="0,16,0,0" />
                    </StackPanel>

                    <!-- ЦЕНТР: холст + курсор -->
                    <Grid Grid.Column="1" Margin="24,0" ClipToBounds="True">
                        <!-- Viewbox уменьшает холст, если места мало,
         но не растягивает больше исходного размера -->
                        <Viewbox Stretch="Uniform"
                                 StretchDirection="DownOnly"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Name="CanvasViewbox">

                            <!-- Внутри остаётся тот же "логический" размер холста -->
                            <Border Width="{x:Static local:AppConfig.CanvasWidth}"
                                    Height="{x:Static local:AppConfig.CanvasHeight}"
                                    CornerRadius="32"
                                    Background="#FBFCFF"
                                    BorderBrush="#D5DFF1"
                                    BorderThickness="2"
                                    Effect="{StaticResource SoftShadow}">
                                <Grid ClipToBounds="True">
                                    <Image Source="{Binding CanvasImage}"
                                           Stretch="Fill" />

                                    <!-- Курсор поверх изображения -->
                                    <Canvas IsHitTestVisible="False" 
                                            Panel.ZIndex="1000"
                                            ClipToBounds="True">
                                        <Ellipse Width="{Binding CursorDiameter}"
                                                 Height="{Binding CursorDiameter}"
                                                 Stroke="{StaticResource AccentBrush}"
                                                 StrokeThickness="2"
                                                 Canvas.Left="{Binding CursorLeft}"
                                                 Canvas.Top="{Binding CursorTop}"
                                                 Fill="{x:Null}" />
                                        <Ellipse Width="4"
                                                 Height="4"
                                                 Fill="{StaticResource AccentBrush}"
                                                 Canvas.Left="{Binding CursorInnerLeft}"
                                                 Canvas.Top="{Binding CursorInnerTop}" />
                                    </Canvas>
                                </Grid>
                            </Border>
                        </Viewbox>
                    </Grid>


                    <!-- ПРАВАЯ КОЛОНКА: образец + палитра + джойстик + фигуры -->
                    <StackPanel Grid.Column="2" VerticalAlignment="Stretch">

                        <!-- Образец -->
                        <Border Style="{StaticResource PanelBorderStyle}">
                            <StackPanel>
                                <TextBlock Text="Образец"
                                           Style="{StaticResource PanelSectionHeaderTextStyle}"
                                           Margin="0,0,0,12" />
                                <Border Background="White"
                                        CornerRadius="12"
                                        Height="150">
                                    <Image Source="{Binding ReferenceImage}"
                                           Stretch="Uniform" />
                                </Border>
                            </StackPanel>
                        </Border>

                        <!-- Палитра -->
                        <controls:PalettePanel Margin="0,16,0,0" />

                        <!-- Кнопка джойстика -->
                        <Button Margin="0,16,0,0"
                                Height="44"
                                Click="OnJoystickModeToggle"
                                Foreground="White"
                                BorderThickness="0"
                                FontSize="12"
                                FontWeight="SemiBold"
                                Background="#9C27B0">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}"
                                            CornerRadius="12"
                                            Padding="12,6">
                                        <ContentPresenter HorizontalAlignment="Center"
                                                          VerticalAlignment="Center" />
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                            <TextBlock Text="{Binding JoystickModeText}"
                                       TextAlignment="Center" />
                        </Button>

                        <!-- Залитые фигуры -->
                        <controls:FilledFiguresPanel Margin="0,16,0,0" />
                    </StackPanel>
                </Grid>

                <!-- ====================== НИЖНЯЯ ПАНЕЛЬ ====================== -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <!-- Статусы -->
                        <ColumnDefinition Width="Auto"/>
                        <!-- Кнопки управления -->
                    </Grid.ColumnDefinitions>

                    <!-- Слева: статус / прогресс (два взаимно исключающих блока) -->
                    <Grid Grid.Column="0" Margin="0,0,24,0">
                        <!-- Сообщение статуса -->
                        <Border CornerRadius="12"
                                Background="#EFF3FB"
                                Padding="16,8"
                                Effect="{StaticResource SoftShadow}"
                                Visibility="{Binding HasStatusMessage, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="{Binding StatusMessage}"
                                       FontSize="14" />
                        </Border>

                        <!-- Прогресс проигрывания -->
                        <Border CornerRadius="12"
                                Background="#F1F4FA"
                                Padding="12,8"
                                Effect="{StaticResource SoftShadow}"
                                Visibility="{Binding IsPlaying, Converter={StaticResource BoolToVisibility}}">
                            <StackPanel>
                                <ProgressBar Value="{Binding PlaybackProgress}"
                                             Maximum="100"
                                             Height="20"
                                             Margin="0,0,0,4"
                                             Background="#E0E0E0"
                                             Foreground="{StaticResource AccentBrush}"
                                             BorderThickness="0" />
                                <TextBlock Text="{Binding PlaybackProgressText}"
                                           FontSize="11"
                                           Foreground="{StaticResource MutedTextBrush}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- Справа: панель управления (наш контрол) -->
                    <controls:PlaybackControls Grid.Column="1"
                           RecordRequested="OnRecordClick"
                           PlaybackRequested="OnPlaybackClick"
                           PauseResumeRequested="OnPauseResumeClick"
                           StopRequested="OnStopPlaybackClick" />

                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
